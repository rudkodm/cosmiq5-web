<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Cosmiq 5 Manager v45 (Env Read Fix)</title>
        <style>
            :root {
                --blue: #007bff;
                --green: #28a745;
                --red: #dc3545;
                --yellow: #ffc107;
                --bg: #f8f9fa;
                --text: #212529;
                --mono:
                    "SFMono-Regular", Consolas, "Liberation Mono", Menlo,
                    Courier, monospace;
            }
            body {
                font-family: -apple-system, sans-serif;
                background: var(--bg);
                color: var(--text);
                padding: 15px;
                max-width: 600px;
                margin: 0 auto;
            }

            header {
                text-align: center;
                margin-bottom: 20px;
            }
            h1 {
                font-size: 20px;
                margin: 0;
                color: #343a40;
            }
            .status {
                font-size: 12px;
                font-weight: 600;
                color: #adb5bd;
                margin-top: 5px;
            }
            .connected {
                color: var(--green);
            }

            button {
                cursor: pointer;
                border: none;
                outline: none;
                font-weight: 600;
                font-family: inherit;
            }
            .btn-main {
                width: 100%;
                padding: 14px;
                border-radius: 10px;
                font-size: 16px;
                color: white;
                background: var(--blue);
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                transition: 0.1s;
                margin-bottom: 10px;
            }
            .btn-main:active {
                transform: scale(0.98);
            }
            .btn-test {
                background: #6f42c1;
            }
            .btn-disc {
                background: #6c757d;
                display: none;
            }

            .tabs {
                display: flex;
                background: white;
                padding: 5px;
                border-radius: 10px;
                margin-bottom: 15px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            }
            .tab {
                flex: 1;
                padding: 10px;
                background: none;
                color: #6c757d;
                border-radius: 8px;
                font-size: 14px;
                transition: 0.2s;
            }
            .tab.active {
                background: var(--blue);
                color: white;
            }

            .section {
                display: none;
                animation: fadeIn 0.3s;
            }
            .section.active {
                display: block;
            }
            @keyframes fadeIn {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }

            .card {
                background: white;
                padding: 15px;
                border-radius: 12px;
                margin-bottom: 12px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            }
            .card h3 {
                margin: 0 0 15px 0;
                font-size: 13px;
                text-transform: uppercase;
                color: #868e96;
                border-bottom: 1px solid #eee;
                padding-bottom: 8px;
            }

            .label {
                font-size: 13px;
                font-weight: 600;
                margin-bottom: 8px;
                display: block;
                color: #495057;
            }
            .grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
                gap: 8px;
            }

            .btn-opt {
                padding: 10px;
                background: #f1f3f5;
                border-radius: 6px;
                color: #495057;
                font-size: 13px;
                transition: 0.2s;
            }
            .btn-opt.selected {
                background: #e3f2fd;
                color: var(--blue);
                border: 1px solid #90caf9;
            }

            .synced {
                animation: flashGreen 1.5s ease-out;
            }
            @keyframes flashGreen {
                0% {
                    background-color: #d4edda;
                }
                100% {
                    background-color: transparent;
                }
            }

            .row {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 15px;
            }
            input[type="range"] {
                flex: 1;
            }
            input[type="number"] {
                width: 60px;
                padding: 8px;
                text-align: center;
                border: 1px solid #ced4da;
                border-radius: 6px;
                font-weight: bold;
                color: var(--blue);
            }
            .val {
                font-family: var(--mono);
                font-weight: bold;
                width: 45px;
                text-align: right;
            }
            .btn-set {
                padding: 8px 16px;
                background: var(--blue);
                color: white;
                border-radius: 6px;
                font-size: 13px;
            }

            .warning-box {
                background: #fff3cd;
                color: #856404;
                padding: 10px;
                border-radius: 6px;
                font-size: 11px;
                margin-top: 10px;
                border: 1px solid #ffeeba;
                display: none;
            }

            #log {
                font-family: var(--mono);
                font-size: 10px;
                color: #aaa;
                margin-top: 20px;
                text-align: left;
                height: 150px;
                overflow-y: scroll;
                padding: 10px;
                border-radius: 8px;
                background: #212529;
                white-space: pre-wrap;
            }
            .log-tx {
                color: #4dabf7;
            }
            .log-rx {
                color: #2ecc71;
            }
            .log-err {
                color: #ff6b6b;
                font-weight: bold;
            }
            .log-info {
                color: #ffd700;
                font-weight: bold;
            }

            /* Byte Hunter Styles */
            .byte-table {
                width: 100%;
                border-collapse: collapse;
                font-family: var(--mono);
                font-size: 12px;
            }
            .byte-table td,
            .byte-table th {
                padding: 6px;
                border-bottom: 1px solid #eee;
            }
            .byte-cell {
                display: inline-block;
                padding: 2px 4px;
                background: #f1f3f5;
                border-radius: 4px;
                margin-right: 2px;
                color: #d63384;
                font-weight: bold;
            }
            .byte-idx {
                font-size: 9px;
                color: #adb5bd;
                display: block;
                text-align: center;
                margin-bottom: 2px;
            }
            .bit-box {
                display: flex;
                gap: 2px;
                margin-top: 5px;
            }
            .bit {
                flex: 1;
                background: #eee;
                text-align: center;
                font-size: 10px;
                padding: 4px 0;
                border-radius: 3px;
            }
            .bit.on {
                background: var(--blue);
                color: white;
            }
        </style>
    </head>
    <body>
        <header>
            <h1>Cosmiq 5 Manager</h1>
            <div id="status" class="status">Disconnected</div>
        </header>

        <button id="connectBtn" class="btn-main" onclick="connect()">
            Connect & Sync
        </button>
        <button
            id="testBtn"
            class="btn-main btn-test"
            onclick="runSystemTest()"
            style="display: none"
        >
            RUN SYSTEM TEST
        </button>
        <button
            id="disconnectBtn"
            class="btn-main btn-disc"
            onclick="disconnect()"
        >
            Disconnect
        </button>

        <div id="app" style="display: none; margin-top: 20px">
            <div class="tabs">
                <button class="tab active" onclick="tab('gen')">General</button>
                <button class="tab" onclick="tab('env')">Environment</button>
                <button class="tab" onclick="tab('scuba')">Scuba</button>
                <button class="tab" onclick="tab('free')">Freedive</button>
                <button class="tab" onclick="tab('hunter')">Byte Hunter</button>
            </div>

            <div id="gen" class="section active">
                <div class="card">
                    <h3>System</h3>
                    <span class="label">Default Mode</span>
                    <div class="grid" id="modeGroup">
                        <button
                            class="btn-opt"
                            id="mode0"
                            onclick="setMode(0, this)"
                        >
                            Scuba
                        </button>
                        <button
                            class="btn-opt"
                            id="mode2"
                            onclick="setMode(2, this)"
                        >
                            Freedive
                        </button>
                        <button
                            class="btn-opt"
                            id="mode1"
                            onclick="setMode(1, this)"
                        >
                            Gauge
                        </button>
                    </div>

                    <div style="margin-top: 15px"></div>
                    <span class="label">Units</span>
                    <div class="grid" id="unitGroup">
                        <button
                            class="btn-opt"
                            id="unit1"
                            onclick="setUnits(1)"
                        >
                            Metric
                        </button>
                        <button
                            class="btn-opt"
                            id="unit0"
                            onclick="setUnits(0)"
                        >
                            Imperial
                        </button>
                    </div>

                    <div style="margin-top: 15px"></div>
                    <span class="label">Date Display</span>
                    <div class="grid" id="dateGroup">
                        <button class="btn-opt" id="date0" onclick="setDate(0)">
                            Current Date
                        </button>
                        <button class="btn-opt" id="date1" onclick="setDate(1)">
                            Last Dive Date
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h3>Display & Power</h3>
                    <span class="label">Screen Timeout</span>
                    <div class="row">
                        <select
                            id="timeoutSel"
                            style="
                                flex: 1;
                                padding: 8px;
                                border-radius: 6px;
                                background: #fff;
                                border: 1px solid #ced4da;
                            "
                        >
                            <option value="0">15 Seconds</option>
                            <option value="1">30 Seconds</option>
                            <option value="2">60 Seconds</option>
                            <option value="3">120 Seconds</option>
                        </select>
                        <button class="btn-set" onclick="setTimeoutIndex()">
                            Set
                        </button>
                    </div>

                    <span class="label">Backlight</span>
                    <div class="grid" id="blGroup">
                        <button class="btn-opt" id="bl3" onclick="setBL(3)">
                            1
                        </button>
                        <button class="btn-opt" id="bl4" onclick="setBL(4)">
                            2
                        </button>
                        <button class="btn-opt" id="bl5" onclick="setBL(5)">
                            3
                        </button>
                        <button class="btn-opt" id="bl6" onclick="setBL(6)">
                            4
                        </button>
                        <button class="btn-opt" id="bl7" onclick="setBL(7)">
                            5
                        </button>
                    </div>

                    <div style="margin-top: 15px"></div>
                    <span class="label">Power-Saving Mode (< 5% Battery)</span>
                    <div class="grid" id="ecoGroup">
                        <button
                            class="btn-opt"
                            id="ecoOn"
                            onclick="setEco(true)"
                        >
                            On
                        </button>
                        <button
                            class="btn-opt"
                            id="ecoOff"
                            onclick="setEco(false)"
                        >
                            Off
                        </button>
                    </div>
                </div>
            </div>

            <div id="env" class="section">
                <div class="card">
                    <h3>Diving Environment</h3>
                    <span class="label">Water / Altitude Mode</span>
                    <div class="grid" id="envGroup">
                        <button class="btn-opt" id="env0" onclick="setEnv(0)">
                            Normal / Sea
                        </button>
                        <button class="btn-opt" id="env1" onclick="setEnv(1)">
                            High Salinity
                        </button>
                        <button class="btn-opt" id="env2" onclick="setEnv(2)">
                            Altitude >300m
                        </button>
                    </div>
                    <div id="salinityWarn" class="warning-box">
                        <strong>⚠️ Advanced Setting</strong><br />
                        Please only use this setting when diving in highly
                        saline water. Your depth readings will be slightly
                        shallower if used in normal ocean water.
                    </div>
                </div>
            </div>

            <div id="scuba" class="section">
                <div class="card">
                    <h3>Safety</h3>
                    <span class="label">Safety Factor</span>
                    <div
                        class="grid"
                        id="safeGroup"
                        style="margin-bottom: 15px"
                    >
                        <button
                            class="btn-opt"
                            id="safe0"
                            onclick="setSafe(0, this)"
                        >
                            Consv
                        </button>
                        <button
                            class="btn-opt"
                            id="safe1"
                            onclick="setSafe(1, this)"
                        >
                            Norm
                        </button>
                        <button
                            class="btn-opt"
                            id="safe2"
                            onclick="setSafe(2, this)"
                        >
                            Prog
                        </button>
                    </div>
                    <span class="label">Max PPO2</span>
                    <div class="row">
                        <input
                            type="range"
                            id="ppo2Range"
                            min="1.2"
                            max="1.6"
                            step="0.1"
                            value="1.4"
                            oninput="upd('ppo2Val', this.value)"
                        />
                        <span class="val" id="ppo2Val">1.4</span>
                        <button class="btn-set" onclick="setPPO2()">Set</button>
                    </div>
                </div>

                <div class="card">
                    <h3>Gas</h3>
                    <span class="label">Air Mix (O2 %)</span>
                    <div class="row">
                        <input
                            type="range"
                            id="airRange"
                            min="21"
                            max="40"
                            step="1"
                            value="21"
                            oninput="upd('airVal', this.value + '%')"
                        />
                        <span class="val" id="airVal">--</span>
                        <button class="btn-set" onclick="setAir()">Set</button>
                    </div>
                </div>

                <div class="card">
                    <h3>Alarms</h3>
                    <div class="row">
                        <span style="font-size: 13px; flex: 1">Depth (m)</span>
                        <input type="number" id="scubaDepth" placeholder="--" />
                        <button class="btn-set" onclick="setScubaDepth()">
                            Set
                        </button>
                    </div>
                    <div class="row">
                        <span style="font-size: 13px; flex: 1">Time (min)</span>
                        <input type="number" id="scubaTime" placeholder="--" />
                        <button class="btn-set" onclick="setScubaTime()">
                            Set
                        </button>
                    </div>
                </div>
            </div>

            <div id="free" class="section">
                <div class="card">
                    <h3>Alarms</h3>
                    <span class="label">Max Time (Seconds)</span>
                    <div class="row" style="margin-bottom: 20px">
                        <input
                            type="range"
                            id="fdTimeRange"
                            min="30"
                            max="600"
                            step="5"
                            value="60"
                            oninput="upd('fdTimeVal', this.value + 's')"
                        />
                        <span class="val" id="fdTimeVal">--</span>
                        <button class="btn-set" onclick="setFdTime()">
                            Set
                        </button>
                    </div>
                    <span class="label">Depth Alarms (m)</span>
                    <div id="fdAlarms"></div>
                </div>
            </div>

            <div id="hunter" class="section">
                <div class="card">
                    <h3>Byte Hunter</h3>
                    <p
                        style="
                            font-size: 12px;
                            color: #666;
                            margin-bottom: 15px;
                        "
                    >
                        Use this tool to find missing settings. <br />
                        Confirmed: $5B (Time/Timeout/Date/Units), $5C (Mode),
                        $5D (Safe/PPO2), $60 (FD6).
                    </p>
                    <button
                        class="btn-main"
                        onclick="readAllSettings()"
                        style="background: #6f42c1; margin-bottom: 15px"
                    >
                        Refetch All
                    </button>
                    <div id="hunterTable">
                        <!-- Populated by JS -->
                        <div
                            style="
                                text-align: center;
                                padding: 20px;
                                color: #aaa;
                            "
                        >
                            No data received yet...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="log">Waiting for connection...</div>

        <script>
            const SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
            let dev, txChar, rxChar;
            let memMap = {}; // Stores latest packets for Hunter

            // Global State for Bitmasked settings
            let sysState = { bl: 5, eco: true }; // Default BL=3 (5), Eco=On

            // UI Init
            const fdDiv = document.getElementById("fdAlarms");
            for (let i = 1; i <= 6; i++) {
                let lbl = "Alarm " + i;
                fdDiv.innerHTML += `<div class="row"><span style="font-size:11px; flex:1">${lbl}</span><input type="number" id="fd${i}" placeholder="--"><button class="btn-set" onclick="setFdDepth(${i})">Set</button></div>`;
            }

            function tab(id) {
                document
                    .querySelectorAll(".section")
                    .forEach((e) => e.classList.remove("active"));
                document
                    .querySelectorAll(".tab")
                    .forEach((e) => e.classList.remove("active"));
                document.getElementById(id).classList.add("active");
                event.target.classList.add("active");
            }
            function upd(id, val) {
                document.getElementById(id).innerText = val;
            }

            function log(m, type = "") {
                console.log(m);
                const el = document.getElementById("log");
                let span = `<span class="${type}">${m}</span>`;
                el.innerHTML += "\n" + span;
                el.scrollTop = el.scrollHeight;
            }

            // Connection
            async function connect() {
                try {
                    log("Scanning...");
                    dev = await navigator.bluetooth.requestDevice({
                        filters: [
                            { namePrefix: "COS" },
                            { namePrefix: "Deep" },
                        ],
                        optionalServices: [SERVICE_UUID],
                    });
                    dev.addEventListener("gattserverdisconnected", onDisc);
                    const server = await dev.gatt.connect();
                    const service =
                        await server.getPrimaryService(SERVICE_UUID);
                    const chars = await service.getCharacteristics();
                    for (const c of chars) {
                        if (
                            c.properties.write ||
                            c.properties.writeWithoutResponse
                        )
                            txChar = c;
                        if (c.properties.notify) rxChar = c;
                    }

                    await rxChar.startNotifications();
                    rxChar.addEventListener(
                        "characteristicvaluechanged",
                        handleRX,
                    );

                    document.getElementById("status").innerText = "Connected";
                    document
                        .getElementById("status")
                        .classList.add("connected");
                    document.getElementById("connectBtn").style.display =
                        "none";
                    document.getElementById("disconnectBtn").style.display =
                        "block";
                    document.getElementById("testBtn").style.display = "block";
                    document.getElementById("app").style.display = "block";

                    log("Reading settings...");
                    await readAllSettings();
                } catch (e) {
                    log("Error: " + e, "log-err");
                }
            }

            function disconnect() {
                if (dev && dev.gatt.connected) dev.gatt.disconnect();
            }
            function onDisc() {
                document.getElementById("status").innerText = "Disconnected";
                document.getElementById("status").classList.remove("connected");
                document.getElementById("connectBtn").style.display = "block";
                document.getElementById("disconnectBtn").style.display = "none";
                document.getElementById("testBtn").style.display = "none";
                document.getElementById("app").style.display = "none";
                log("Disconnected.");
            }

            // RX Handler
            function handleRX(event) {
                let dec = new TextDecoder("utf-8");
                let text = dec.decode(event.target.value);
                let clean = text.replace(/[^0-9A-Fa-f]/g, "").toUpperCase();

                if (clean.startsWith("80")) {
                    log("!!! COMMAND REJECTED !!!", "log-err");
                    return;
                }

                log("RX: " + text.trim(), "log-rx");

                if (clean.length < 4) return;
                let cmd = clean.substr(0, 2);

                // Store for Byte Hunter
                memMap[cmd] = clean;
                updateHunter();

                // Parsing Logic
                if (cmd === "5F") {
                    // System: Backlight, Eco, Environment
                    // Byte 1 (8-9): Environment Mode (0=Norm, 1=Salt, 2=Alt)
                    let env = parseInt(clean.substr(8, 2), 16);
                    if (!isNaN(env) && env <= 2) {
                        highlightBtn("envGroup", "env" + env);
                        document.getElementById("salinityWarn").style.display =
                            env === 1 ? "block" : "none";
                        log("> Parsed Env: " + env);
                    }

                    // Byte 2 (10-11): Raw Backlight + Eco Flag
                    // Backlight = Lower 4 bits. Eco = Bit 4 (0x10).
                    // Log analysis: 0x05 = BL3, Eco ON. 0x15 = BL3, Eco OFF.
                    let raw = parseInt(clean.substr(10, 2), 16);
                    if (!isNaN(raw)) {
                        let bl = raw & 0x0f; // Lower nibble
                        let ecoDisabled = (raw & 0x10) > 0; // Bit 4 High = Eco Off

                        sysState.bl = bl;
                        sysState.eco = !ecoDisabled;

                        highlightBtn("blGroup", "bl" + bl);

                        // Update Eco UI
                        document
                            .getElementById("ecoOn")
                            .classList.remove("selected");
                        document
                            .getElementById("ecoOff")
                            .classList.remove("selected");
                        if (sysState.eco)
                            document
                                .getElementById("ecoOn")
                                .classList.add("selected");
                        else
                            document
                                .getElementById("ecoOff")
                                .classList.add("selected");

                        log(
                            `> Parsed Sys: BL Level ${bl - 2}, Eco ${sysState.eco ? "ON" : "OFF"}`,
                        );
                    }
                }

                if (cmd === "5C") {
                    // Scuba 1
                    let depth = (parseInt(clean.substr(6, 4), 16) - 1000) / 100;
                    syncInput("scubaDepth", depth);

                    let air = parseInt(clean.substr(14, 2), 16);
                    if (!isNaN(air)) {
                        document.getElementById("airRange").value = air;
                        upd("airVal", air + "%");
                    }

                    // Byte 5 (16-17): Default Mode
                    let mode = parseInt(clean.substr(16, 2), 16);
                    if (!isNaN(mode)) {
                        highlightBtn("modeGroup", "mode" + mode);
                        log("> Parsed Mode: " + mode);
                    }

                    log("> Parsed: Depth:" + depth + "m Air:" + air + "%");
                }

                if (cmd === "5B") {
                    // Scuba 2
                    // Byte 1 (8-9): Time Alarm
                    let timeAlarm = parseInt(clean.substr(8, 2), 16);
                    if (!isNaN(timeAlarm)) {
                        syncInput("scubaTime", timeAlarm);
                        log("> Parsed Scuba Time Alarm: " + timeAlarm);
                    }

                    // Byte 3 (12-13): Screen Timeout
                    let timeOut = parseInt(clean.substr(12, 2), 16);
                    if (timeOut < 10) {
                        document.getElementById("timeoutSel").value = timeOut;
                        document
                            .getElementById("timeoutSel")
                            .parentElement.classList.add("synced");
                        setTimeout(
                            () =>
                                document
                                    .getElementById("timeoutSel")
                                    .parentElement.classList.remove("synced"),
                            1000,
                        );
                        log("> Parsed Timeout Index: " + timeOut);
                    }

                    // Byte 4 (14-15): Date Mode
                    let dMode = parseInt(clean.substr(14, 2), 16);
                    if (!isNaN(dMode)) {
                        highlightBtn("dateGroup", "date" + dMode);
                        log("> Parsed Date Mode: " + dMode);
                    }

                    // Byte 5 (16-17): Units
                    let uMode = parseInt(clean.substr(16, 2), 16);
                    if (!isNaN(uMode)) {
                        highlightBtn("unitGroup", "unit" + uMode);
                        log("> Parsed Units: " + uMode);
                    }
                }

                if (cmd === "5D") {
                    // Freedive 1-4, Safety, PPO2
                    // Bytes 0-3: Alarms 1-4
                    for (let i = 0; i < 4; i++) {
                        let val = parseInt(clean.substr(6 + i * 2, 2), 16);
                        syncInput("fd" + (i + 1), val + 5);
                    }

                    // Byte 4 (14-15): Safety Factor (0=Consv, 1=Norm, 2=Prog)
                    let safe = parseInt(clean.substr(14, 2), 16);
                    if (safe >= 0 && safe <= 2) {
                        highlightBtn("safeGroup", "safe" + safe);
                        log("> Parsed Safety: " + safe);
                    }

                    // Byte 5 (16-17): PPO2
                    let ppo2Raw = parseInt(clean.substr(16, 2), 16);
                    if (!isNaN(ppo2Raw)) {
                        let ppo2 = ppo2Raw / 10;
                        document.getElementById("ppo2Range").value = ppo2;
                        upd("ppo2Val", ppo2.toFixed(1));
                        log("> Parsed PPO2: " + ppo2.toFixed(1));
                    }
                }
                if (cmd === "60") {
                    // Freedive Time & Alarms 5-6
                    // Byte 0 (6-7): Time Factor
                    let sec = parseInt(clean.substr(6, 2), 16) * 5 + 30;
                    syncInput("fdTimeRange", sec);
                    upd("fdTimeVal", sec + "s");

                    // Byte 1 (8-9): Alarm 5 (Assumed)
                    let fda5 = parseInt(clean.substr(8, 2), 16);
                    if (!isNaN(fda5)) {
                        syncInput("fd5", fda5 + 5);
                    }

                    // Byte 2 (10-11): Alarm 6
                    let fda6 = parseInt(clean.substr(10, 2), 16);
                    if (!isNaN(fda6)) {
                        syncInput("fd6", fda6 + 5);
                        log("> Parsed FD Alarm 6: " + (fda6 + 5) + "m");
                    }
                }
            }

            function updateHunter() {
                let html = `<table class="byte-table"><tr><th>CMD</th><th>Payload (Raw Hex)</th></tr>`;
                const commands = [
                    { id: "58", desc: "System ($58)" },
                    { id: "5F", desc: "System ($5F)" },
                    { id: "5C", desc: "Scuba 1 ($5C)" },
                    { id: "5B", desc: "Scuba 2 ($5B)" },
                    { id: "5D", desc: "FD Depth ($5D)" },
                    { id: "60", desc: "FD Time ($60)" },
                ];

                commands.forEach((c) => {
                    let raw = memMap[c.id] || "No Data";
                    let payloadHtml = "";
                    if (raw !== "No Data") {
                        // Skip CMD(2), CHK(2), LEN(2) -> Start at 6
                        let payload = raw.substring(6);
                        for (let i = 0; i < payload.length; i += 2) {
                            payloadHtml += `<div class="byte-cell"><span class="byte-idx">${i / 2}</span>${payload.substr(i, 2)}</div>`;
                        }
                    }
                    html += `<tr><td><strong>${c.id}</strong><br><span style="font-size:10px">${c.desc}</span></td><td>${payloadHtml || raw}</td></tr>`;
                });
                html += `</table>`;
                document.getElementById("hunterTable").innerHTML = html;
            }

            async function readAllSettings() {
                const qs = [
                    "#58a60200",
                    "#5f9f0200",
                    "#5ba30200",
                    "#5ca20200",
                    "#5da10200",
                    "#609e0200",
                ];
                for (const q of qs) {
                    await sendStatic(q, "Read Config");
                    await new Promise((r) => setTimeout(r, 300));
                }
            }

            async function runSystemTest() {
                log("--- STARTING SYSTEM TEST ---", "log-info");
                log("1. Set Safety -> Progressive");
                await setSafe(2, document.getElementById("safe2")); // Fixed index
                await new Promise((r) => setTimeout(r, 800));

                log("2. Set Air -> 32%");
                document.getElementById("airRange").value = 32;
                await setAir();
                await new Promise((r) => setTimeout(r, 800));

                log("--- VERIFYING ---", "log-info");
                await readAllSettings();
            }

            async function sendStatic(str, desc = "") {
                if (!txChar) return;
                let enc = new TextEncoder();
                await txChar.writeValue(enc.encode(str + "\n"));
                if (!desc) desc = str;
                log(`<span class="log-tx">TX: ${desc}</span>`);
            }

            async function sendCalcSum(
                prefix,
                targetSum,
                valHex,
                lenHex = "02",
                desc = "",
            ) {
                let v = valHex.toLowerCase();
                let p = prefix.toLowerCase();
                let payloadBytes = [];
                payloadBytes.push(parseInt(lenHex, 16));
                for (let i = 0; i < v.length; i += 2)
                    payloadBytes.push(parseInt(v.substr(i, 2), 16));

                let sum = payloadBytes.reduce((a, b) => a + b, 0);
                let checkDec = (targetSum - sum) & 0xff;
                let checkHex = checkDec
                    .toString(16)
                    .padStart(2, "0")
                    .toLowerCase();

                await sendStatic(`#${p}${checkHex}${lenHex}${v}`, desc);
            }

            // --- FUNCTIONS ---

            // Environment: 0=Norm, 1=Salt, 2=Alt. CMD 30, Target 208.
            function setEnv(v) {
                // UI Toggle
                document
                    .getElementById("envGroup")
                    .querySelectorAll(".btn-opt")
                    .forEach((b) => b.classList.remove("selected"));
                document.getElementById("env" + v).classList.add("selected");

                // Show/Hide Warning
                document.getElementById("salinityWarn").style.display =
                    v === 1 ? "block" : "none";

                let h = "0" + v;
                sendCalcSum("30", 208, "000" + v, "04", "Set Environment " + v);
                // No verify for now as reading location is unknown
            }

            // Backlight & Eco: Share CMD 2E, Target 210.
            // Raw Value = Lower 4 bits (BL) | Bit 4 (Eco Off flag)
            // Eco ON = Bit 4 Low (0). Eco OFF = Bit 4 High (1).
            function setBL(l) {
                highlightBtn("blGroup", "bl" + l);
                sysState.bl = l;
                sendBLEcoPacket();
            }

            function setEco(isOn) {
                sysState.eco = isOn;
                // UI Toggle
                document.getElementById("ecoOn").classList.remove("selected");
                document.getElementById("ecoOff").classList.remove("selected");
                if (isOn)
                    document.getElementById("ecoOn").classList.add("selected");
                else
                    document.getElementById("ecoOff").classList.add("selected");

                sendBLEcoPacket();
            }

            function sendBLEcoPacket() {
                let blBits = sysState.bl;
                let ecoFlag = sysState.eco ? 0x00 : 0x10; // 0=On, 10=Off
                let total = blBits | ecoFlag;
                let hex = total.toString(16).padStart(2, "0");
                sendCalcSum("2e", 210, hex, "02", "Set Sys/BL " + hex);
                verify("sys");
            }

            // Safety Factor: Target 223 (Algo A)
            // Log verified: Consv=0, Norm=1, Prog=2
            // Packet: #21[Chk]04000[Val]
            function setSafe(s, btn) {
                highlightBtn("safeGroup", btn.id);
                let valStr = "000" + s;
                sendCalcSum("21", 223, valStr, "04", "Set Safety " + s);
                verify("free"); // Safety is in $5D (Free)
            }

            function setMode(m, btn) {
                highlightBtn("modeGroup", btn.id);
                let c =
                    m === 0 ? "#2bd30200" : m === 2 ? "#2bd10202" : "#2bd20201";
                sendStatic(c, "Set Mode");
                verify("scuba1");
            }

            function setTimeoutIndex() {
                let idx = parseInt(document.getElementById("timeoutSel").value);
                let h = idx.toString(16).padStart(4, "0");
                sendCalcSum("2a", 214, h, "04", "Set Timeout Idx " + idx);
                verify("scuba2");
            }

            function setAir() {
                let v = parseInt(document.getElementById("airRange").value);
                sendCalcSum(
                    "22",
                    222,
                    v.toString(16).padStart(2, "0"),
                    "02",
                    "Set Air " + v + "%",
                );
                verify("scuba1");
            }

            function setPPO2() {
                let v = parseFloat(document.getElementById("ppo2Range").value);
                sendCalcSum(
                    "2d",
                    211,
                    Math.round(v * 10)
                        .toString(16)
                        .padStart(2, "0"),
                    "02",
                    "Set PPO2 " + v,
                );
                verify("free");
            }

            function setUnits(m) {
                sendCalcSum("23", 221, "0" + m, "02", "Set Units " + m);
            }

            function setDate(m) {
                sendCalcSum("24", 220, "0" + m, "02", "Set DateFmt " + m);
            }

            function setScubaDepth() {
                let m = parseInt(document.getElementById("scubaDepth").value);
                sendCalcSum(
                    "27",
                    217,
                    (m * 100 + 1000).toString(16).padStart(4, "0"),
                    "04",
                    "Set Depth " + m + "m",
                );
                verify("scuba1");
            }
            function setScubaTime() {
                let m = parseInt(document.getElementById("scubaTime").value);
                sendCalcSum(
                    "28",
                    216,
                    m.toString(16).padStart(4, "0"),
                    "04",
                    "Set Time " + m + "min",
                );
                verify("scuba2");
            }

            function setFdTime() {
                let s = parseInt(document.getElementById("fdTimeRange").value);
                sendCalcSum(
                    "26",
                    218,
                    "14" + ((s - 30) / 5).toString(16).padStart(2, "0"),
                    "04",
                    "Set FD Time " + s + "s",
                );
                setTimeout(async () => {
                    await sendStatic("#609e0200");
                }, 600);
            }

            function setFdDepth(idx) {
                let m = parseInt(document.getElementById("fd" + idx).value);
                let h = (m - 5).toString(16).padStart(2, "0");
                let pre = "25",
                    tgt = 219,
                    pay = "0a" + h;
                if (idx === 2) pay = h + "13";
                if (idx === 3) {
                    pre = "31";
                    tgt = 207;
                    pay = "19" + h;
                }
                if (idx === 4) {
                    pre = "31";
                    tgt = 207;
                    pay = h + "14";
                }
                if (idx === 5) {
                    pre = "32";
                    tgt = 206;
                    pay = "32" + h;
                }

                if (idx === 6) {
                    pre = "32";
                    tgt = 206;
                    pay = h + "1e";
                }

                sendCalcSum(
                    pre,
                    tgt,
                    pay,
                    "04",
                    "Set FD Depth " + idx + " to " + m + "m",
                );

                if (idx <= 4) verify("free");
                if (idx >= 5)
                    setTimeout(async () => {
                        await sendStatic("#609e0200", "Verify FD5/6");
                    }, 600);
            }

            function highlightBtn(grp, id) {
                document
                    .getElementById(grp)
                    .querySelectorAll(".btn-opt")
                    .forEach((b) => b.classList.remove("selected"));
                let btn = document.getElementById(id);
                if (btn) btn.classList.add("selected");
            }
            function syncInput(id, val) {
                let el = document.getElementById(id);
                if (!isNaN(val) && el) {
                    el.value = val;
                    el.parentElement.classList.add("synced");
                    setTimeout(
                        () => el.parentElement.classList.remove("synced"),
                        1000,
                    );
                }
            }
            function verify(type) {
                let cmd = "";
                if (type === "sys") cmd = "#5f9f0200";
                if (type === "scuba1") cmd = "#5ca20200";
                if (type === "scuba2") cmd = "#5ba30200";
                if (type === "free") cmd = "#5da10200";
                if (cmd)
                    setTimeout(async () => {
                        await sendStatic(cmd, "Verify");
                    }, 600);
            }
        </script>
    </body>
</html>
